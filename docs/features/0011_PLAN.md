# PLAN TÉCNICO - Transición Automática de ACUSE a RANKING

## Descripción de la Funcionalidad

El usuario quiere implementar una transición automática del estado del juego. Cuando se detecte que todos los jugadores han enviado sus acusaciones (estado = ACUSE), y si el jugador actual es el jugador 1, entonces se cambiará automáticamente el estado del juego a RANKING. Cuando se detecte ese nuevo estado, se mostrará una nueva pantalla con el texto "RANKING" en el centro, que será la base para futuras evoluciones de la funcionalidad.

**Prompt del usuario**: "Ahora quiero que, si eres el jugador 1, y se detecta que todos los jugadores han enviado sus acusaciones (en el state = ACUSE), entonces se cambie el state = RANKING. Cuando se detecte ese state, se mostrará la página ahora un texto en el centro que pone "RANKING" y que luego seguiremos evolucionando."

## Archivos y Funciones que Deben Cambiarse

### 1. `web/script.js`
- **Función existente**: Modificar `updateAccusationsCounter()` para detectar cuando todos han enviado acusaciones
- **Función existente**: Modificar `setupAccusationsTracking()` para incluir lógica de transición automática
- **Función existente**: Modificar `renderScreen()` para manejar estado 'RANKING'
- **Nueva función**: `renderRankingScreen()` para renderizar la pantalla de ranking
- **Función existente**: Modificar `cleanupAccusationsTracking()` para limpiar listeners de ranking

### 2. `web/firebase-database.js`
- **Función existente**: Usar `updateGameState()` para cambiar a estado 'RANKING'

### 3. `web/index.html`
- **Nueva pantalla**: Agregar pantalla de ranking con texto "RANKING" centrado

### 4. `web/styles.css`
- **Nuevos estilos**: Para la pantalla de ranking y el texto centrado

### 5. `web/lib.js`
- **Función existente**: Usar `changeGameState()` para transiciones de estado

## Algoritmo de Detección y Transición

### Función `updateAccusationsCounter()` Modificada

1. **Input**: `accusationsData` (datos de acusaciones desde Firebase)
2. **Obtener progreso**: Llamar a `getAccusationsProgress(accusationsData, totalPlayers)`
3. **Verificar completitud**: Si `progress.totalSent === progress.totalExpected`
4. **Verificar jugador 1**: Solo proceder si `isPlayerOne(gameState)`
5. **Cambiar estado**: Llamar a `updateGameState(gameCode, 'RANKING')`
6. **Actualizar estado local**: Usar `changeGameState(gameState, 'RANKING')`
7. **Re-renderizar**: Llamar a `renderScreen(gameState)`

### Función `renderRankingScreen()`

1. **Input**: `gameState` (estado actual del juego)
2. **Ocultar pantallas**: Desactivar todas las pantallas del juego
3. **Mostrar ranking**: Activar la pantalla de ranking
4. **Limpiar tracking**: Llamar a `cleanupAccusationsTracking()`

### Función `renderScreen()` Modificada

1. **Input**: `gameState` (estado actual del juego)
2. **Switch statement**: Agregar caso 'RANKING' que llame a `renderRankingScreen()`
3. **Mantener casos existentes**: 'START' y 'ACUSE' sin cambios

## Fases de Implementación

### Fase 1: Lógica de Detección y Transición
- Modificar `updateAccusationsCounter()` para detectar cuando todos han enviado acusaciones
- Implementar lógica de transición automática solo para jugador 1
- Usar `updateGameState()` para cambiar estado en Firebase
- Actualizar estado local y re-renderizar

### Fase 2: Pantalla de Ranking
- Crear nueva pantalla en HTML con texto "RANKING" centrado
- Implementar `renderRankingScreen()` en script.js
- Modificar `renderScreen()` para manejar estado 'RANKING'
- Agregar estilos CSS para la nueva pantalla

### Fase 3: Limpieza y Testing
- Modificar `cleanupAccusationsTracking()` para limpiar listeners de ranking
- Verificar que la transición funcione correctamente
- Asegurar que solo el jugador 1 pueda cambiar el estado
- Mantener separación de responsabilidades entre core y DOM

## Consideraciones Técnicas

### Inmutabilidad
- **Funciones puras**: Todas las funciones de transición retornan nuevos objetos
- **Sin side effects**: No modificar estado global directamente
- **Spread operator**: Usar para crear copias inmutables del estado

### Seguridad
- **Validación de jugador**: Solo el jugador 1 puede cambiar el estado
- **Verificación de completitud**: Confirmar que realmente todos han enviado acusaciones
- **Manejo de errores**: Capturar y manejar errores en la transición

### Performance
- **Listener único**: Mantener el listener de acusaciones activo hasta la transición
- **Cleanup automático**: Limpiar listeners cuando se cambie de pantalla
- **Re-renderizado eficiente**: Solo re-renderizar cuando sea necesario

### UX
- **Transición automática**: El usuario no necesita hacer nada manual
- **Feedback visual**: Mostrar claramente el cambio de estado
- **Consistencia**: Mantener el mismo estilo visual que otras pantallas
