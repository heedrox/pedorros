# PLAN TÉCNICO - Funcionalidad de Acusación

## Descripción de la Funcionalidad

El usuario quiere implementar la funcionalidad de acusación en el juego PEDORROS. Cuando el estado del juego cambie a 'ACUSE', se debe mostrar una nueva pantalla que permita a los jugadores acusar a otros jugadores de ser peditos o pedorros mediante un sistema de botones con colores que cambian cíclicamente (verde → naranja → rojo → verde).

**Prompt del usuario**: "Lo que vamos a hacer es tener un listener al arrancar la aplicacion del campo de BD de state (creo que el listener ya existe), y cuando state = 'ACUSE' vamos a mostrar la siguiente pantalla: (header habitual de PEDORROS) [Si tu numero de jugador coincide con el valor de pedorro, entonces se muestra central arriba en grande "¡ERES EL PEDORRO!"] Y luego tantos botones como numero de jugadores (a ser posible en grid de 4 columnas, por ejemplo, y numerados como JUG. 1, JUG. 2, etc.). Todos los botones están por defecto en verde. Funcionamiento botones: - Al pulsar cada boton de jugador, pasan de verde a naranja y de naranja a rojo y de rojo a verde. - Cuando un jugador lo pone en naranja, es que está acusando a ese jugador de ser pedito. - Cuando lo pone en rojo, está acusando al jugador a ser pedorro. Por lo tanto, tiene que poner tantos verdes, naranjas y rojos como neutrales, peditos y pedorros haya en la partida. Si al cambiar un boton, y recalcular el numero de peditos y pedorros, coincide con el de la tabla que ves en @PRODUCT_BRIEF.md , entonces el boton "ACUSAR" se activa."

## Archivos y Funciones que Deben Cambiarse

### Archivos HTML
- **`web/index.html`**: Agregar nueva pantalla de acusación con botones de jugadores y botón ACUSAR

### Archivos CSS  
- **`web/styles.css`**: Agregar estilos para la pantalla de acusación, botones de jugadores (verde/naranja/rojo), grid de 4 columnas, y botón ACUSAR

### Archivos JavaScript
- **`web/script.js`**: 
  - Modificar `renderScreen()` para manejar estado 'ACUSE'
  - Agregar `renderAcuseScreen()` para renderizar la pantalla de acusación
  - Agregar lógica de manejo de botones de jugadores
  - Agregar validación de acusaciones según tabla de distribución
  - Agregar event listeners para botones de jugadores y ACUSAR

- **`web/lib.js`**:
  - Agregar función `validateAccusations(accusations, totalPlayers)` para validar que las acusaciones coincidan con la distribución de roles
  - Agregar función `getAccusationState(accusations, playerNumber)` para obtener el estado actual de acusación de un jugador

## Algoritmo de Validación de Acusaciones

### Función `validateAccusations(accusations, totalPlayers)`

1. **Input**: `accusations` (objeto con playerNumber -> 'verde'|'naranja'|'rojo'), `totalPlayers` (número)
2. **Obtener distribución esperada**: Usar tabla del PRODUCT_BRIEF para obtener número de peditos, pedorros y neutrales
3. **Contar acusaciones actuales**:
   - Verdes = neutrales
   - Naranjas = peditos  
   - Rojos = pedorros
4. **Validar coincidencia**: Retornar `{ success: boolean, error?: string }`
5. **Importante**: Solo valida CANTIDADES, no si los jugadores específicos están bien acusados

### Función `getAccusationState(accusations, playerNumber)`

1. **Input**: `accusations` (objeto), `playerNumber` (número)
2. **Retornar**: Estado actual del jugador ('verde'|'naranja'|'rojo'|'verde')

## Fases de Implementación

### Fase 1: Estructura HTML y CSS
- Crear pantalla de acusación en HTML con grid de botones
- Implementar estilos CSS para botones de colores y layout respetando la paleta oficial de marrones
- Agregar botón ACUSAR (inicialmente deshabilitado) con estilos consistentes

### Fase 2: Lógica de Renderizado
- Modificar `renderScreen()` para detectar estado 'ACUSE'
- Implementar `renderAcuseScreen()` con lógica de renderizado funcional
- Mostrar mensaje "¡ERES EL PEDORRO!" cuando corresponda
- Mantener separación de responsabilidades entre core (lib.js) y DOM (script.js)

### Fase 3: Funcionalidad de Botones
- Implementar cambio cíclico de colores en botones de jugadores
- Agregar event listeners para cada botón de jugador
- Implementar lógica de estado local de acusaciones con funciones puras

### Fase 4: Validación y Activación
- Implementar `validateAccusations()` en lib.js como función pura
- Implementar `getAccusationState()` en lib.js como función pura
- Conectar validación con activación del botón ACUSAR
- Agregar event listener para botón ACUSAR

## Detalles Técnicos Específicos

### Estados de Botones
- **Verde**: Jugador neutral (no acusado) - usar color de la paleta oficial de marrones
- **Naranja**: Acusado de ser pedito - usar color de la paleta oficial de marrones
- **Rojo**: Acusado de ser pedorro - usar color de la paleta oficial de marrones
- **Nota**: Los colores específicos deben ser aprobados para mantener coherencia con la guía de estilos oficial

### Grid de Botones
- Layout de 4 columnas para dispositivos móviles
- Botones numerados como "JUG. 1", "JUG. 2", etc.
- Responsive design para diferentes tamaños de pantalla
- Seguir el patrón de diseño responsive establecido en el proyecto
- Mantener coherencia visual con la temática marrón existente

### Validación en Tiempo Real
- Cada cambio de botón debe recalcular y validar acusaciones
- Solo activar botón ACUSAR cuando las CANTIDADES de acusaciones coincidan exactamente con la distribución esperada
- **NO validar si los jugadores específicos están bien acusados** - solo contar verdes/naranjas/rojos
- Usar la función `calculateGameRoles()` existente para obtener la distribución esperada

### Integración con Estado Existente
- El listener de Firebase ya existe y detecta cambios de estado
- La función `calculateGameRoles()` ya está implementada y testeada
- La tabla de distribución ya está definida en PRODUCT_BRIEF.md
- Seguir arquitectura funcional e inmutable establecida en el proyecto
- Mantener separación entre core (lib.js) y lógica de DOM (script.js)
- Respetar la paleta oficial de colores marrones documentada en README.md

## Consideraciones de Testing

- Crear tests unitarios para `validateAccusations()` y `getAccusationState()` siguiendo el patrón existente
- Crear tests de integración para el flujo completo de acusación
- **Verificar que `validateAccusations()` solo valide CANTIDADES, no jugadores específicos**
- Verificar que el botón ACUSAR solo se active cuando las cantidades coincidan (sin importar si los jugadores están bien acusados)
- Verificar que los colores cambien cíclicamente correctamente
- Verificar que el mensaje "¡ERES EL PEDORRO!" se muestre solo para el jugador correcto
- Mantener cobertura de tests al nivel actual (81 tests) y agregar nuevos tests para esta funcionalidad
- Seguir principios de testing funcional: inmutabilidad, funciones puras, sin side effects
