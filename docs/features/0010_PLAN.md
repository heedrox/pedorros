# PLAN TÉCNICO - Funcionalidad ACUSAR

## Descripción de la Funcionalidad

Implementar la funcionalidad completa del botón ACUSAR en la pantalla ACUSE. Cuando un jugador pulsa ACUSAR, se guardará en Firebase Database bajo el documento "acusations" del juego correspondiente, almacenando las acusaciones de ese jugador específico sin sobrescribir las de otros jugadores.

**Prompt del usuario**: "Vamos a implementar la funcionalidad de ACUSAR. El botón de la pantalla ACUSE. Cuando un jugador pulsa ACUSAR, guardará en base de datos, bajo el código de juego de siempre, bajo el documento 'acusations' (/pedorros-game/{codigojuego}/acusations), un elemento: acusationX: { 1: 'neutral', 2: 'pedito', 3: 'pedorro', 4: 'pedito', 5: 'neutral' } Siendo X = numero de jugador que hace la acusacion. Importante, que el documento 'acusations' no se sobreescriba entero, sino solo la parte que le toca a su jugador 'acusationX'. Como ves, no hay que usar 'verde', 'naranja' y 'rojo' para enviar la informacion, sino 'neutral', 'pedito', 'pedorro'."

**Nueva funcionalidad solicitada**: "Para el jugador 1, y solo para el jugador 1, vamos a poner un contador debajo del botón ACUSAR que muestre 'Acusaciones enviadas: X, Y, Z', siendo X, Y, Z, los jugadores que han enviado las acusaciones. Es decir, necesitamos escuchar ese documento y cuando haya actualizaciones, actualizar esa capa."

## Archivos y Funciones que Deben Cambiarse

### 1. `web/firebase-database.js`
- **Nueva función**: `savePlayerAccusations(gameCode, playerNumber, accusations)`
- **Nueva función**: `setupAccusationsListener(gameCode, callback)` - Listener para cambios en acusaciones
- **Función existente**: Modificar `updateGameState()` para incluir acusaciones

### 2. `web/script.js`
- **Función existente**: Modificar el event listener del botón ACUSAR (línea ~557)
- **Función existente**: Modificar `validateAndUpdateAcusarButton()` para incluir validación de acusaciones
- **Función existente**: Modificar `renderAcuseScreen()` para mostrar estado de acusaciones guardadas
- **Nueva función**: `setupAccusationsTracking()` - Configurar listener de acusaciones para jugador 1
- **Nueva función**: `updateAccusationsCounter(accusationsData)` - Actualizar contador visual

### 3. `web/lib.js`
- **Nueva función**: `convertAccusationColorsToRoles(accusationsState)`
- **Nueva función**: `validateAccusationFormat(accusations)`
- **Nueva función**: `getAccusationsProgress(accusationsData, totalPlayers)` - Obtener progreso de acusaciones
- **Función existente**: Modificar `validateAccusations()` para incluir validación de formato

### 4. `web/index.html`
- **Nuevo elemento**: Contenedor para el contador de acusaciones (solo visible para jugador 1)

### 5. `web/styles.css`
- **Nuevos estilos**: Para el contador de acusaciones enviadas

### 6. `test/unit/acusaciones.test.js`
- **Nuevos tests**: Para las nuevas funciones de conversión y validación
- **Nuevos tests**: Para la función `getAccusationsProgress`
- **Tests existentes**: Actualizar para incluir validación de formato de acusaciones

## Algoritmo de Implementación

### Fase 1: Capa de Datos y Core (lib.js)
1. **Función de conversión de colores a roles**:
   - Mapear 'verde' → 'neutral'
   - Mapear 'naranja' → 'pedito' 
   - Mapear 'rojo' → 'pedorro'
   - Validar que todas las acusaciones estén en el formato correcto

2. **Función de validación de formato**:
   - Verificar que las acusaciones contengan solo valores válidos ('neutral', 'pedito', 'pedorro')
   - Validar que el número de acusaciones coincida con el total de jugadores
   - Retornar objeto con éxito/error y mensaje descriptivo

3. **Nueva función de progreso de acusaciones**:
   - Analizar documento `acusations` de Firebase
   - Extraer números de jugadores que han enviado acusaciones
   - Retornar array ordenado de jugadores con acusaciones completas

### Fase 2: Base de Datos (firebase-database.js)
1. **Función de guardado de acusaciones**:
   - Usar `update()` de Firebase para modificar solo el campo `acusationX` específico
   - Estructura: `/pedorros-game/{codigojuego}/acusations/acusationX`
   - No sobrescribir el documento completo, solo la parte del jugador
   - Retornar objeto con éxito/error y timestamp de guardado

2. **Nueva función de listener de acusaciones**:
   - Configurar listener en tiempo real para documento `acusations`
   - Detectar cambios cuando se añaden/eliminan acusaciones
   - Ejecutar callback con datos actualizados

3. **Integración con estado del juego**:
   - Modificar `updateGameState()` para incluir campo de acusaciones si es necesario
   - Mantener compatibilidad con funcionalidades existentes

### Fase 3: Interfaz de Usuario (script.js)
1. **Modificación del botón ACUSAR**:
   - Convertir estado local de colores a roles antes de enviar
   - Validar formato antes de enviar a Firebase
   - Mostrar feedback visual de éxito/error
   - Deshabilitar botón después de acusación exitosa

2. **Validación y feedback**:
   - Validar que las acusaciones cumplan con la distribución esperada
   - Mostrar mensaje de confirmación o error según corresponda
   - Actualizar estado visual de la pantalla ACUSE

3. **Nueva funcionalidad de tracking de acusaciones**:
   - Configurar listener solo para jugador 1 (director del juego)
   - Actualizar contador visual en tiempo real
   - Mostrar progreso: "Acusaciones enviadas: 1, 3, 5" (ejemplo)

4. **Persistencia de estado**:
   - Cargar acusaciones existentes desde Firebase al renderizar pantalla
   - Mostrar estado de acusaciones previas si existen
   - Permitir modificación de acusaciones antes de confirmar

### Fase 4: HTML y CSS
1. **Contenedor de contador**:
   - Añadir elemento debajo del botón ACUSAR
   - Solo visible para jugador 1
   - Estilo consistente con la temática marrón existente

2. **Estilos del contador**:
   - Diseño responsive y legible
   - Integración visual con el resto de la pantalla ACUSE

## Estructura de Datos en Firebase

```json
{
  "pedorros-game": {
    "galerna": {
      "acusations": {
        "acusation1": {
          "1": "neutral",
          "2": "pedito", 
          "3": "pedorro",
          "4": "pedito",
          "5": "neutral"
        },
        "acusation2": {
          "1": "pedito",
          "2": "neutral",
          "3": "pedorro", 
          "4": "neutral",
          "5": "pedito"
        }
      }
    }
  }
}
```

## Consideraciones Técnicas

### Inmutabilidad
- Mantener el estado local `accusationsState` inmutable usando spread operator
- Las funciones de conversión deben retornar nuevos objetos sin modificar los originales
- Validar que no haya side effects en las operaciones de Firebase

### Manejo de Errores
- Validar formato de acusaciones antes de enviar a Firebase
- Manejar errores de red y base de datos de forma elegante
- Mostrar mensajes de error específicos al usuario

### Compatibilidad
- Mantener compatibilidad con funcionalidades existentes (DISIMULAR, INVESTIGAR)
- No romper el flujo de juego actual
- Preservar la arquitectura funcional e inmutable existente

### Testing
- Crear tests unitarios para las nuevas funciones de conversión
- Crear tests para la función de progreso de acusaciones
- Actualizar tests existentes para incluir validación de formato
- Mantener cobertura de tests al 100%

## Validaciones Críticas

1. **Formato de acusaciones**: Solo valores 'neutral', 'pedito', 'pedorro'
2. **Cantidad de acusaciones**: Debe coincidir con `totalPlayers`
3. **Distribución válida**: Las cantidades deben coincidir con la tabla del PRODUCT_BRIEF
4. **Permisos**: Solo el jugador correspondiente puede modificar su `acusationX`
5. **Integridad de datos**: No sobrescribir acusaciones de otros jugadores
6. **Listener de acusaciones**: Solo activo para jugador 1 (director del juego)

## Flujo de Usuario

1. Jugador selecciona colores en la pantalla ACUSE (verde/naranja/rojo)
2. Sistema valida que las cantidades coincidan con distribución esperada
3. Botón ACUSAR se habilita automáticamente
4. Al pulsar ACUSAR:
   - Se convierten colores a roles (neutral/pedito/pedorro)
   - Se valida formato y distribución
   - Se guarda en Firebase solo la parte del jugador
   - Se muestra confirmación visual
   - Se deshabilita botón ACUSAR
5. Las acusaciones quedan persistentes en Firebase para futuras referencias
6. **NUEVO**: Para jugador 1, se actualiza contador en tiempo real mostrando "Acusaciones enviadas: X, Y, Z"

## Funcionalidad Adicional del Contador

### Comportamiento del Contador
- **Solo visible para jugador 1**: El director del juego puede ver el progreso
- **Actualización en tiempo real**: Se actualiza automáticamente cuando otros jugadores envían acusaciones
- **Formato del mensaje**: "Acusaciones enviadas: 1, 3, 5" (jugadores que han completado)
- **Posicionamiento**: Debajo del botón ACUSAR, integrado visualmente con la pantalla

### Listener de Firebase
- **Ruta específica**: `/pedorros-game/{codigojuego}/acusations`
- **Eventos escuchados**: `onValue` para cambios en tiempo real
- **Callback**: Actualiza contador visual con progreso actual
- **Cleanup**: Se desconecta cuando se cambia de pantalla o se reinicia el juego
