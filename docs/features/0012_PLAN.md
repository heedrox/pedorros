# PLAN TÉCNICO - Función calculateRoundScore

## Descripción de la Funcionalidad

El usuario quiere implementar una función `calculateRoundScore` que calcule la puntuación de la ronda para todos los jugadores. Esta función debe procesar las acusaciones de todos los jugadores, los roles reales (peditos y pedorro), y aplicar las reglas de puntuación para determinar cuántos puntos obtiene cada jugador en esa ronda.

**Prompt del usuario**: "Quiero que hagamos una función 'calculateRoundScore' que lo que haga es calcular la puntuación de la ronda para todos los jugadores. Entrada: - acusations, como un objeto { acusation1: { 1: 'pedito', 2: 'neutral', 3: 'pedorro', ... }, acusation2: {}, acusation3: ... } que indica lo que acusa cada uno (y es lo que hay ahora en BD si no me equivoco). - peditos: array de numeros que dice que jugadores son los peditos. - pedorro: numero que dice que jugador es el pedorro. Salida: - un objeto { 1: 12, 2: 8, 3: 9, ... }, siendo 12, 8, 9 los puntos de esa ronda para cada jugador. Forma de calcular la puntuacion por cada ronda para cada jugador: - Por cada pedito que ese jugador ha acertado: 1 punto adicional. - Si ese jugador no es pedorro: si acierta pedorro 5 puntos adicionales pero solo si otra persona ha acertado (que no sea él). - Si ese jugador es el pedorro: se lleva 10 puntos adicionales si nadie ha acertado que él es el pedorro. Si alguien acierta, no se lleva nada más. Por favor, haz tests para casos de puntuacion."

## Archivos y Funciones que Deben Cambiarse

### 1. `web/lib.js`
- **Nueva función**: `calculateRoundScore(acusations, peditos, pedorro)` - función principal de cálculo
- **Nueva función**: `calculatePlayerScore(playerNumber, playerAccusations, peditos, pedorro, allAccusations)` - cálculo individual por jugador
- **Nueva función**: `countPeditoHits(playerAccusations, peditos)` - contar aciertos de peditos
- **Nueva función**: `countPedorroHits(allAccusations, pedorro)` - contar aciertos del pedorro
- **Nueva función**: `validateScoreInputs(acusations, peditos, pedorro)` - validación de entradas

### 2. `test/unit/calculateRoundScore.test.js`
- **Nuevo archivo**: Tests unitarios para todas las funciones de puntuación
- **Casos de prueba**: Diferentes escenarios de acusaciones y roles
- **Tests de edge cases**: Validaciones de entrada y casos límite

## Algoritmo de Cálculo de Puntuación

### Función Principal `calculateRoundScore()`

1. **Input**: 
   - `acusations`: Objeto con acusaciones de todos los jugadores
   - `peditos`: Array de números de jugadores que son peditos
   - `pedorro`: Número del jugador que es el pedorro

2. **Validación**: Llamar a `validateScoreInputs()` para verificar entradas válidas

3. **Cálculo por jugador**: Para cada jugador, llamar a `calculatePlayerScore()`

4. **Output**: Objeto con puntuación de cada jugador `{ 1: 12, 2: 8, ... }`

### Función `calculatePlayerScore()`

1. **Input**: Número de jugador, sus acusaciones, roles reales, todas las acusaciones

2. **Puntos base**: 0 puntos iniciales

3. **Puntos por peditos**: Llamar a `countPeditoHits()` y sumar 1 punto por cada acierto

4. **Puntos por pedorro**:
   - Si el jugador NO es pedorro: verificar si acertó al pedorro y si otra persona también acertó
   - Si el jugador ES pedorro: verificar si nadie lo acusó correctamente

5. **Output**: Puntuación total del jugador

### Función `countPeditoHits()`

1. **Input**: Acusaciones del jugador, array de peditos reales

2. **Contador**: Inicializar en 0

3. **Verificación**: Para cada acusación del jugador, verificar si coincide con un pedito real

4. **Output**: Número de aciertos de peditos

### Función `countPedorroHits()`

1. **Input**: Todas las acusaciones, número del pedorro real

2. **Contador**: Inicializar en 0

3. **Verificación**: Para cada jugador, verificar si acusó correctamente al pedorro

4. **Output**: Número de aciertos del pedorro

### Función `validateScoreInputs()`

1. **Input**: Acusaciones, peditos, pedorro

2. **Validaciones**:
   - Verificar que acusations sea un objeto válido
   - Verificar que peditos sea un array de números
   - Verificar que pedorro sea un número válido
   - Verificar que no haya conflictos entre peditos y pedorro

3. **Output**: Objeto con `{ valid: boolean, errors: [] }`

## Reglas de Puntuación Detalladas

### Puntos por Peditos
- **Regla**: 1 punto por cada pedito que el jugador acertó
- **Ejemplo**: Si el jugador acusó correctamente a 2 peditos, obtiene 2 puntos

### Puntos por Pedorro (Jugador NO es pedorro)
- **Regla**: 5 puntos si acertó al pedorro Y otra persona también acertó
- **Condición**: Debe haber al menos 2 aciertos al pedorro (incluyendo el jugador)
- **Ejemplo**: Si solo el jugador acertó al pedorro, no obtiene los 5 puntos

### Puntos por Pedorro (Jugador ES pedorro)
- **Regla**: 10 puntos si nadie acertó que él es el pedorro
- **Condición**: Cero aciertos al pedorro en todas las acusaciones
- **Ejemplo**: Si al menos una persona acertó, no obtiene los 10 puntos

## Fases de Implementación

### Fase 1: Funciones de Validación y Utilidad
- Implementar `validateScoreInputs()` con validaciones completas
- Implementar `countPeditoHits()` para contar aciertos de peditos
- Implementar `countPedorroHits()` para contar aciertos del pedorro
- Crear tests unitarios para estas funciones

### Fase 2: Cálculo Individual de Puntuación
- Implementar `calculatePlayerScore()` con todas las reglas de puntuación
- Crear tests unitarios para diferentes escenarios de puntuación
- Verificar que las reglas se apliquen correctamente

### Fase 3: Función Principal y Tests de Integración
- Implementar `calculateRoundScore()` que coordine todos los cálculos
- Crear tests de integración con casos reales del juego
- Verificar que la función maneje correctamente todos los casos

## Casos de Prueba para Tests

### Caso 1: Ronda Simple (4 jugadores)
- **Input**: 
  - `peditos: [2, 3]`, `pedorro: 1`
  - `acusations: { acusation1: {1: 'neutral', 2: 'pedito', 3: 'pedito', 4: 'neutral'}, acusation2: {...}, ... }`
- **Expected**: Verificar puntuaciones según reglas

### Caso 2: Pedorro Descubierto
- **Input**: Todos acusan correctamente al pedorro
- **Expected**: Pedorro obtiene 0 puntos extra, otros obtienen 5 puntos si acertaron

### Caso 3: Pedorro Oculto
- **Input**: Nadie acusa correctamente al pedorro
- **Expected**: Pedorro obtiene 10 puntos extra

### Caso 4: Solo Uno Acierta al Pedorro
- **Input**: Solo un jugador acusa correctamente al pedorro
- **Expected**: Ese jugador obtiene 0 puntos extra por pedorro

### Caso 5: Múltiples Aciertos de Peditos
- **Input**: Varios jugadores acusan correctamente a diferentes peditos
- **Expected**: Cada jugador obtiene 1 punto por cada pedito que acertó

## Consideraciones Técnicas

### Inmutabilidad
- **Funciones puras**: Todas las funciones retornan nuevos objetos sin modificar entradas
- **Sin side effects**: No modificar estado global o entradas
- **Spread operator**: Usar para crear copias inmutables cuando sea necesario

### Validación de Datos
- **Entradas robustas**: Manejar casos donde las acusaciones estén incompletas
- **Tipos de datos**: Verificar que los tipos sean correctos antes de procesar
- **Casos límite**: Manejar arrays vacíos, objetos nulos, etc.

### Performance
- **Algoritmo eficiente**: Evitar loops anidados innecesarios
- **Cálculos optimizados**: Minimizar iteraciones sobre los datos
- **Memoria**: No crear objetos temporales innecesarios

### Testing
- **Cobertura completa**: Tests para todos los casos de uso
- **Edge cases**: Validar comportamiento con entradas inesperadas
- **Casos reales**: Tests que simulen situaciones reales del juego
