# PLAN TÉCNICO - Botón SIGUIENTE RONDA

## Descripción de la Funcionalidad

El usuario quiere añadir un botón "SIGUIENTE RONDA" que solo sea visible para el jugador 1 (director del juego). Este botón debe reiniciar el juego para la siguiente ronda, cambiando el estado a "START", limpiando campos específicos de la base de datos, e incrementando el número de ronda.

**Prompt del usuario**: "ok, vamos a añadir un boton debajo del ranking que SOLO VEA EL JUGADOR 1, que ponga SIGUIENTE RONDA. Lo que va a hacer es cambiar el state = 'START', y borrara 'acusations' y 'lastRoundScore' y 'nextSounds' y 'peditos' y 'pedorro', e indrementara en 1 el valor de 'numRound'."

## Archivos y Funciones que Deben Cambiarse

### 1. `web/index.html`
- **Modificar pantalla ranking**: Añadir botón "SIGUIENTE RONDA" debajo de la tabla de ranking
- **Condición de visibilidad**: El botón solo debe ser visible para el jugador 1

### 2. `web/script.js`
- **Función existente**: Modificar `renderRankingTable()` para incluir el botón
- **Nueva función**: `handleNextRoundClick()` - Maneja el click del botón SIGUIENTE RONDA
- **Función existente**: Modificar `renderRankingTable()` para pasar el `playerNumber` del `gameState`

### 3. `web/firebase-database.js`
- **Nueva función**: `resetGameForNextRound(gameCode, newNumRound)` - Limpia campos específicos y actualiza ronda
- **Función existente**: Modificar `updateGameState()` para incluir limpieza de campos en la misma operación

### 4. `web/styles.css`
- **Nuevos estilos**: Para el botón SIGUIENTE RONDA con diseño consistente
- **Estilos responsive**: Adaptación para móviles y tablets

## Algoritmo de Reinicio para Siguiente Ronda

### Función `handleNextRoundClick()`

1. **Input**: `gameState` (estado actual del juego)
2. **Validación**: Verificar que el jugador actual sea el jugador 1
3. **Cálculo**: Incrementar `numRound` en 1
4. **Limpieza**: Llamar a `resetGameForNextRound()` para limpiar campos específicos
5. **Cambio de estado**: Actualizar estado a "START" con nueva ronda
6. **Re-renderizar**: Llamar a `renderScreen(gameState)` para mostrar pantalla START

### Función `resetGameForNextRound()`

1. **Input**: `gameCode`, `newNumRound`
2. **Campos a limpiar**:
   - `acusations` → `null` o `{}`
   - `lastRoundScore` → `null` o `{}`
   - `nextSounds` → `null` o `{}`
   - `peditos` → `null` o `[]`
   - `pedorro` → `null`
3. **Campos a actualizar**:
   - `state` → `"START"`
   - `numRound` → `numRound++`
4. **Operación Firebase**: Usar `update()` para modificar solo los campos específicos
5. **Output**: Resultado de la operación con éxito/error

### Función `renderRankingTable()` Modificada

1. **Input**: `ranking`, `lastRoundScore`, `totalPlayers`, `numRound`, `playerNumber`
2. **Generar tabla**: Crear HTML de la tabla de ranking como antes
3. **Condición de botón**: Solo mostrar botón si `playerNumber === 1`
4. **Insertar botón**: Añadir botón "SIGUIENTE RONDA" debajo de la tabla
5. **Event listener**: Configurar click handler para el botón

## Estructura de Datos en Firebase

### Antes del Reinicio
```
/pedorros-game/{codigojuego}/
├── state: "RANKING"
├── numRound: 3
├── ranking: { 1: 15, 2: 23, 3: 8, 4: 12 }
├── lastRoundScore: { 1: 2, 2: 5, 3: 1, 4: 3 }
├── acusations: { acusation1: {...}, acusation2: {...}, ... }
├── nextSounds: { 1: 3, 2: 1, 3: 4, 4: 2 }
├── peditos: [2, 3]
└── pedorro: 1
```

### Después del Reinicio
```
/pedorros-game/{codigojuego}/
├── state: "START"
├── numRound: 4
├── ranking: { 1: 15, 2: 23, 3: 8, 4: 12 } (se mantiene)
├── lastRoundScore: null
├── acusations: null
├── nextSounds: null
├── peditos: null
└── pedorro: null
```

## Fases de Implementación

### Fase 1: Botón en HTML y Estilos CSS
- Añadir botón "SIGUIENTE RONDA" en la pantalla de ranking
- Crear estilos CSS para el botón con diseño consistente
- Implementar estilos responsive para móviles y tablets

### Fase 2: Lógica de Reinicio en Firebase
- Implementar `resetGameForNextRound()` para limpiar campos específicos
- Verificar que la operación sea atómica (todos los cambios en una transacción)
- Manejar errores y validaciones de entrada

### Fase 3: Integración en script.js
- Modificar `renderRankingTable()` para incluir el botón condicionalmente
- Implementar `handleNextRoundClick()` con validación de jugador 1
- Integrar con el flujo de cambio de estado y re-renderizado

### Fase 4: Testing y Validación
- Verificar que solo el jugador 1 vea el botón
- Probar que el reinicio funcione correctamente
- Validar que los campos se limpien y la ronda se incremente

## Consideraciones Técnicas

### Seguridad
- **Validación de jugador**: Solo el jugador 1 puede ejecutar el reinicio
- **Verificación de estado**: Solo permitir reinicio desde estado "RANKING"
- **Manejo de errores**: Capturar y manejar errores en la operación de Firebase

### Inmutabilidad
- **Funciones puras**: Todas las funciones retornan nuevos objetos sin modificar entradas
- **Sin side effects**: No modificar estado global directamente
- **Spread operator**: Usar para crear copias inmutables del estado

### Performance
- **Operación atómica**: Actualizar todos los campos en una sola transacción Firebase
- **Cleanup eficiente**: Limpiar solo los campos necesarios
- **Re-renderizado optimizado**: Solo re-renderizar cuando sea necesario

### UX
- **Visibilidad condicional**: Botón solo visible para el director del juego
- **Feedback visual**: Confirmación de que la operación se ejecutó correctamente
- **Transición suave**: Cambio de pantalla RANKING → START sin interrupciones

## Casos de Prueba

### Caso 1: Jugador 1 Ve el Botón
- **Input**: `playerNumber = 1`, estado = "RANKING"
- **Expected**: Botón "SIGUIENTE RONDA" visible y funcional

### Caso 2: Otros Jugadores No Ven el Botón
- **Input**: `playerNumber = 2, 3, 4...`, estado = "RANKING"
- **Expected**: Botón "SIGUIENTE RONDA" no visible

### Caso 3: Reinicio Exitoso
- **Input**: Click en botón desde estado "RANKING", ronda actual = 3
- **Expected**: 
  - `state` = "START"
  - `numRound` = 4
  - Campos específicos limpiados
  - Ranking mantenido
  - Transición a pantalla START

### Caso 4: Manejo de Errores
- **Input**: Error en Firebase durante el reinicio
- **Expected**: Error capturado y manejado graciosamente, estado no cambia

### Caso 5: Validación de Estado
- **Input**: Intentar reinicio desde estado diferente a "RANKING"
- **Expected**: Operación bloqueada o error apropiado
